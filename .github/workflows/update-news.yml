name: Daily News API Update

on:
  schedule:
    - cron: '0 6 * * *'  # 9:00 –ú–°–ö
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  update:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - run: npm install
      
      # –®–∞–≥ 1: –ü–æ–ª—É—á–∞–µ–º –Ω–æ–≤—ã–µ —Å–æ–±—ã—Ç–∏—è –∏–∑ API
      - name: Fetch new events
        env:
          NEWS_API_KEY: ${{ secrets.NEWS_API_KEY }}
        run: |
          echo "=== –ü–û–õ–£–ß–ï–ù–ò–ï –ù–û–í–´–• –°–û–ë–´–¢–ò–ô ==="
          node news-api.js
      
      # –®–∞–≥ 2: –ê—Ä—Ö–∏–≤–∏—Ä—É–µ–º (–¥–æ–±–∞–≤–ª—è–µ–º –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º, —É–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ)
      - name: Archive events
        run: |
          echo "=== –ê–†–•–ò–í–ê–¶–ò–Ø ==="
          node archive-events.js
      
      # –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –ø–æ–ª—É—á–∏–ª–æ—Å—å
      - name: Verify files
        run: |
          echo "=== –ü–†–û–í–ï–†–ö–ê –§–ê–ô–õ–û–í ==="
          ls -lh data/
          echo ""
          echo "events.json (–¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è):"
          head -100 data/events.json
          echo ""
          echo "events-archive.json (–∞—Ä—Ö–∏–≤):"
          head -50 data/events-archive.json
      
      # –®–∞–≥ 4: –ö–æ–º–º–∏—Ç–∏–º –æ–±–∞ —Ñ–∞–π–ª–∞
      - name: Commit changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "üîÑ Update: $(date +'%Y-%m-%d') | –ê—Ä—Ö–∏–≤: $(jq '.metadata.totalEvents' data/events-archive.json) —Å–æ–±—ã—Ç–∏–π"
          file_pattern: 'data/*.json'
      
      # –®–∞–≥ 5: –ü–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ–º GitHub Pages
      - name: Trigger Pages rebuild
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.repos.requestPagesBuild({
              owner: context.repo.owner,
              repo: context.repo.repo
            })
        continue-on-error: true
